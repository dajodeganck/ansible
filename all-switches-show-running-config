---
- name: "Show Running Configuration and Push to GitHub"
  hosts: switches
  gather_facts: no
  serial: 1
  become: yes
  become_user: user  # Change to the appropriate user if necessary
  tasks:
    - name: Show Running Config asynchronously
      cisco.ios.ios_command:
        commands: show running-config
      register: output
      async: 600  # Increase the async timeout
      poll: 0

    - name: Wait for the Show Running Config task to complete
      async_status:
        jid: "{{ output.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 50  # Increase the number of retries
      delay: 15  # Increase the delay between retries

    - name: Create temporary file with running config
      copy:
        content: "{{ job_result.results[0].stdout if job_result.results is defined and job_result.results[0].stdout is defined else 'No results found' }}"
        dest: "/home/user/backup/{{ inventory_hostname }}_backup.txt"

    - name: Ensure the local git repository exists
      command: git init /home/user/backup
      args:
        creates: /home/user/backup/.git
      delegate_to: localhost

    - name: Change working directory to git repository
      command: chdir=/home/user/backup git add {{ inventory_hostname }}_backup.txt
      delegate_to: localhost

    - name: Commit the new config file
      command: chdir=/home/user/backup git commit -m "Add running config for {{ inventory_hostname }}"
      delegate_to: localhost
      ignore_errors: yes

    - name: Set up GitHub remote
      command: chdir=/home/user/backup git remote add origin https://github.com/dajodeganck/ansible.git
      delegate_to: localhost
      args:
        creates: /home/user/backup/.git/config
      ignore_errors: yes

    - name: Push the commit to GitHub
      command: chdir=/home/user/backup git push origin main
      delegate_to: localhost
      environment:
        GIT_SSH_COMMAND: 'ssh -i /path/to/your/ssh/key'

    - name: Remove temporary file
      file:
        path: "/home/user/backup/{{ inventory_hostname }}_backup.txt"
        state: absent
      delegate_to: localhost

    # Uncomment below if using HTTPS with a personal access token
    # - name: Push the commit to GitHub (HTTPS)
    #   command: chdir=/home/user/backup git push origin main
    #   delegate_to: localhost
    #   environment:
    #     GIT_HTTPS_USER: "USERNAME"
    #     GIT_HTTPS_PASSWORD: "TOKEN"
