---
- name: "Show Running Configuration and Push to GitHub"
  hosts: switches
  gather_facts: no
  serial: 1
  tasks:
    - name: Show Running Config asynchronously
      cisco.ios.ios_command:
        commands: show running-config
      register: output
      async: 600  # Increase the async timeout
      poll: 0

    - name: Wait for the Show Running Config task to complete
      async_status:
        jid: "{{ output.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 50  # Increase the number of retries
      delay: 15  # Increase the delay between retries

    - name: Ensure the local git repository exists
      local_action:
        module: command
        cmd: git init /tmp/ansible_backup
      args:
        creates: /tmp/ansible_backup/.git

    - name: Configure Git user email
      local_action:
        module: command
        cmd: git config --global user.email "your_email@example.com"
      ignore_errors: yes

    - name: Configure Git user name
      local_action:
        module: command
        cmd: git config --global user.name "Your Name"
      ignore_errors: yes

    - name: Create temporary file with running config
      local_action:
        module: copy
        content: "{{ job_result.results[0].stdout if job_result.results is defined and job_result.results[0].stdout is defined else 'No results found' }}"
        dest: "/tmp/ansible_backup/{{ inventory_hostname }}_backup.txt"

    - name: Add new config file to git
      local_action:
        module: command
        cmd: git add {{ inventory_hostname }}_backup.txt
      args:
        chdir: /tmp/ansible_backup

    - name: Commit the new config file
      local_action:
        module: command
        cmd: git commit -m "Add running config for {{ inventory_hostname }}"
      args:
        chdir: /tmp/ansible_backup
      ignore_errors: yes

    - name: Ensure initial commit exists
      local_action:
        module: command
        cmd: git commit --allow-empty -m "Initial commit"
      args:
        chdir: /tmp/ansible_backup
      when: "not job_result.results[0].stdout"

    - name: Set up GitHub remote
      local_action:
        module: command
        cmd: git remote add origin https://github.com/dajodeganck/ansible.git
      args:
        chdir: /tmp/ansible_backup
        creates: /tmp/ansible_backup/.git/config
      ignore_errors: yes

    - name: Push the commit to GitHub
      local_action:
        module: command
        cmd: git push origin main
      args:
        chdir: /tmp/ansible_backup
      environment:
        GIT_SSH_COMMAND: 'ssh -i /path/to/your/ssh/key'

    - name: Remove temporary file from git repository
      local_action:
        module: file
        path: "/tmp/ansible_backup/{{ inventory_hostname }}_backup.txt"
        state: absent

    # Uncomment below if using HTTPS with a personal access token
    # - name: Push the commit to GitHub (HTTPS)
    #   local_action:
    #     module: command
    #     cmd: git push origin main
    #   args:
    #     chdir: /tmp/ansible_backup
    #   environment:
    #     GIT_HTTPS_USER: "USERNAME"
    #     GIT_HTTPS_PASSWORD: "TOKEN"
